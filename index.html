<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>바코드 생성 데모</title>
    <!-- 외부 라이브러리 -->
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <script src="https://sdk.cc-embed.adobe.com/v2/CCEverywhere.js"></script>
    <style>
        /* 컨테이너 스타일 */
        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            font-family: Arial, sans-serif;
        }

        /* 입력 섹션 스타일 */
        .input-section {
            background-color: #f5f5f5;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        /* 입력 그룹 스타일 */
        .input-group {
            margin-bottom: 15px;
        }

        .input-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #333;
        }

        .input-group input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        /* 미리보기 섹션 스타일 */
        .preview-section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background-color: white;
        }

        /* 바코드 아이템 스타일 */
        .barcode-item {
            text-align: center;
            margin: 20px 0;
            padding: 20px;
            background-color: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        /* 버튼 섹션 스타일 */
        .button-section {
            grid-column: 1 / -1;
            display: flex;
            gap: 10px;
        }

        /* 버튼 스타일 */
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.3s;
        }

        button:hover {
            background-color: #0056b3;
        }

        /* 기타 스타일 */
        .export-section {
            margin-top: 20px;
        }

        .info-text {
            font-size: 12px;
            color: #666;
            margin-top: 4px;
        }

        .error {
            color: red;
            font-size: 12px;
            margin-top: 5px;
        }

        #adobe-express-editor {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1000;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>바코드 라벨 생성기</h1>
        
        <!-- 입력 폼 섹션 -->
        <div class="input-section">
            <div class="input-group">
                <label for="productName">상품명 (한글)</label>
                <input type="text" id="productName" placeholder="상품명 입력">
            </div>
            <div class="input-group">
                <label for="productNameEng">상품명 (영문)</label>
                <input type="text" id="productNameEng" placeholder="영문 상품명 입력">
            </div>
            <div class="input-group">
                <label for="optionName">옵션명 (한글)</label>
                <input type="text" id="optionName" placeholder="옵션명 입력">
            </div>
            <div class="input-group">
                <label for="optionNameEng">옵션명 (영문)</label>
                <input type="text" id="optionNameEng" placeholder="영문 옵션명 입력">
            </div>
            <div class="input-group">
                <label for="productNumber">상품번호</label>
                <input type="text" id="productNumber" placeholder="상품번호 입력">
            </div>
            <div class="input-group">
                <label for="lotNumber">로트번호</label>
                <input type="text" id="lotNumber" placeholder="로트번호 입력">
            </div>
            <div class="input-group">
                <label for="barcodeNumber">바코드 번호 (13자리)</label>
                <input type="text" id="barcodeNumber" placeholder="880으로 시작하는 13자리" maxlength="13">
                <div class="info-text">* 예시: 8801234567893</div>
            </div>
            <div class="button-section">
                <button onclick="generateBarcode()">바코드 생성</button>
                <button onclick="exportToSVG()">SVG 저장</button>
                <button onclick="exportToAI()">AI 저장</button>
                <button onclick="exportToPDF()">PDF 저장</button>
            </div>
        </div>

        <!-- 미리보기 섹션 -->
        <div class="preview-section">
            <div id="barcodePreview"></div>
        </div>
    </div>

    <div id="adobe-express-editor"></div>

    <script>
        // Adobe Express SDK 전역 변수
        let adobeEditor = null;

        // Adobe Express 설정
        const adobeExpressConfig = {
            clientId: '384098285fec415db985afb346f4ca40',
            appName: '바코드 라벨 생성기',
            locale: 'ko_KR',
            targetElement: 'adobe-express-editor',
            modalParams: {
                parentElementId: 'adobe-express-editor'
            }
        };

        // 체크섬 계산 함수
        function calculateCheckDigit(barcode12) {
            let sum = 0;
            for (let i = 0; i < 12; i++) {
                sum += parseInt(barcode12[i]) * (i % 2 === 0 ? 1 : 3);
            }
            return (10 - (sum % 10)) % 10;
        }

        // 바코드 생성 함수
        function generateBarcode() {
            const barcodeInput = document.getElementById('barcodeNumber').value.trim();
            
            // 입력값 검증
            if (!validateBarcodeInput(barcodeInput)) return;

            const cleanedBarcode = barcodeInput.replace(/[^\d]/g, '');
            const previewDiv = document.getElementById('barcodePreview');
            previewDiv.innerHTML = '';

            createBarcodePreview(cleanedBarcode, previewDiv);
        }

        // 바코드 입력값 검증 함수
        function validateBarcodeInput(barcodeInput) {
            if (!barcodeInput) {
                alert('바코드 번호를 입력해주세요.');
                return false;
            }

            const cleanedBarcode = barcodeInput.replace(/[^\d]/g, '');

            if (cleanedBarcode.length !== 13) {
                alert('바코드 번호는 13자리 숫자여야 합니다.');
                return false;
            }

            if (!cleanedBarcode.startsWith('880')) {
                alert('한국 바코드는 880으로 시작해야 합니다.');
                return false;
            }

            const barcode12 = cleanedBarcode.slice(0, 12);
            const providedCheckDigit = parseInt(cleanedBarcode[12]);
            const calculatedCheckDigit = calculateCheckDigit(barcode12);

            if (providedCheckDigit !== calculatedCheckDigit) {
                const correctBarcode = barcode12 + calculatedCheckDigit;
                document.getElementById('barcodeNumber').value = correctBarcode;
                alert(`체크섬이 수정되었습니다. 새로운 바코드 번호: ${correctBarcode}`);
                return false;
            }

            return true;
        }

        // 바코드 미리보기 생성 함수
        function createBarcodePreview(barcodeNumber, previewDiv) {
            const barcodeContainer = document.createElement('div');
            barcodeContainer.className = 'barcode-item';

            try {
                const canvas = document.createElement('canvas');
                
                JsBarcode(canvas, barcodeNumber, {
                    format: "EAN13",
                    width: 2,
                    height: 100,
                    displayValue: true,
                    fontSize: 14,
                    margin: 10
                });

                const productInfo = getProductInfo();
                barcodeContainer.innerHTML = generateProductInfoHTML(productInfo);
                barcodeContainer.appendChild(canvas);
                previewDiv.appendChild(barcodeContainer);
            } catch (error) {
                console.error(error);
                alert('바코드 생성 중 오류가 발생했습니다.');
            }
        }

        // 제품 정보 가져오기 함수
        function getProductInfo() {
            return {
                productName: document.getElementById('productName').value,
                productNameEng: document.getElementById('productNameEng').value,
                optionName: document.getElementById('optionName').value,
                optionNameEng: document.getElementById('optionNameEng').value,
                productNumber: document.getElementById('productNumber').value,
                lotNumber: document.getElementById('lotNumber').value
            };
        }

        // 제품 정보 HTML 생성 함수
        function generateProductInfoHTML(info) {
            return `
                <p><strong>상품명:</strong> ${info.productName} / ${info.productNameEng}</p>
                <p><strong>옵션명:</strong> ${info.optionName} / ${info.optionNameEng}</p>
                <p><strong>상품번호:</strong> ${info.productNumber}</p>
                <p><strong>로트번호:</strong> ${info.lotNumber}</p>
            `;
        }

        // SVG 저장 함수
        function exportToSVG() {
            const preview = document.getElementById('barcodePreview');
            const barcodeNumber = document.getElementById('barcodeNumber').value;
            
            if (!preview.innerHTML) {
                alert('먼저 바코드를 생성해주세요.');
                return;
            }

            try {
                const canvas = preview.querySelector('canvas');
                if (!canvas) throw new Error('바코드를 찾을 수 없습니다.');

                const productInfo = getProductInfo();
                const svgString = generateSVGString(canvas, productInfo, barcodeNumber);
                downloadSVG(svgString, barcodeNumber);
            } catch (error) {
                console.error(error);
                alert('SVG 저장 중 오류가 발생했습니다.');
            }
        }

        // SVG 문자열 생성 함수
        function generateSVGString(canvas, info, barcodeNumber) {
            return `<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<svg xmlns="http://www.w3.org/2000/svg" 
     xmlns:xlink="http://www.w3.org/1999/xlink"
     width="${canvas.width}" 
     height="${canvas.height + 100}"
     version="1.1"
     viewBox="0 0 ${canvas.width} ${canvas.height + 100}">
    <defs/>
    <g id="BarcodeLayer">
        <image x="0" y="0" 
               width="${canvas.width}" 
               height="${canvas.height}"
               xlink:href="${canvas.toDataURL('image/png')}"/>
    </g>
    <g id="TextLayer" font-family="Arial" font-size="12">
        <text x="10" y="${canvas.height + 20}">
            <tspan x="10" dy="0">상품명: ${info.productName} / ${info.productNameEng}</tspan>
        </text>
        <text x="10" y="${canvas.height + 40}">
            <tspan x="10" dy="0">옵션명: ${info.optionName} / ${info.optionNameEng}</tspan>
        </text>
        <text x="10" y="${canvas.height + 60}">
            <tspan x="10" dy="0">상품번호: ${info.productNumber}</tspan>
        </text>
        <text x="10" y="${canvas.height + 80}">
            <tspan x="10" dy="0">로트번호: ${info.lotNumber}</tspan>
        </text>
        <text x="10" y="${canvas.height + 100}">
            <tspan x="10" dy="0">바코드: ${barcodeNumber}</tspan>
        </text>
    </g>
</svg>`;
        }

        // SVG 다운로드 함수
        function downloadSVG(svgString, barcodeNumber) {
            const blob = new Blob([svgString], { type: 'image/svg+xml;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            
            const link = document.createElement('a');
            link.href = url;
            link.download = `${barcodeNumber}.svg`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }

        // AI 저장 함수
        async function exportToAI() {
            const preview = document.getElementById('barcodePreview');
            const barcodeNumber = document.getElementById('barcodeNumber').value;
            
            if (!preview.innerHTML) {
                alert('먼저 바코드를 생성���주세요.');
                return;
            }

            try {
                const canvas = preview.querySelector('canvas');
                if (!canvas) {
                    throw new Error('바코드를 찾을 수 없습니다.');
                }

                // 제품 정보 가져오기
                const productName = document.getElementById('productName').value;
                const productNameEng = document.getElementById('productNameEng').value;
                const optionName = document.getElementById('optionName').value;
                const optionNameEng = document.getElementById('optionNameEng').value;
                const productNumber = document.getElementById('productNumber').value;
                const lotNumber = document.getElementById('lotNumber').value;

                // SVG 데이터 생성
                const svgData = `<?xml version="1.0" encoding="UTF-8"?>
<svg xmlns="http://www.w3.org/2000/svg" 
     xmlns:xlink="http://www.w3.org/1999/xlink"
     width="${canvas.width}" 
     height="${canvas.height + 100}">
    <g id="BarcodeLayer">
        <image x="0" y="0" 
               width="${canvas.width}" 
               height="${canvas.height}"
               xlink:href="${canvas.toDataURL('image/png')}"/>
    </g>
    <g id="TextLayer" font-family="Arial" font-size="12">
        <text x="10" y="${canvas.height + 20}">
            <tspan x="10" dy="0">상품명: ${productName} / ${productNameEng}</tspan>
        </text>
        <text x="10" y="${canvas.height + 40}">
            <tspan x="10" dy="0">옵션명: ${optionName} / ${optionNameEng}</tspan>
        </text>
        <text x="10" y="${canvas.height + 60}">
            <tspan x="10" dy="0">상품번호: ${productNumber}</tspan>
        </text>
        <text x="10" y="${canvas.height + 80}">
            <tspan x="10" dy="0">로트번호: ${lotNumber}</tspan>
        </text>
    </g>
</svg>`;

                try {
                    // 이미 초기화된 에디터가 있으면 재사용
                    if (!adobeEditor) {
                        adobeEditor = await CCEverywhere.initialize(adobeExpressConfig);
                    }

                    // 편집기에 SVG 데이터 전달
                    await adobeEditor.openFile({
                        data: svgData,
                        mimeType: 'image/svg+xml',
                        filename: `${barcodeNumber}.svg`
                    });

                } catch (error) {
                    // 에디터 초기화 오류 시 재시도
                    console.error('에디터 초기화 오류:', error);
                    adobeEditor = null;
                    
                    // 다시 시도
                    adobeEditor = await CCEverywhere.initialize(adobeExpressConfig);
                    await adobeEditor.openFile({
                        data: svgData,
                        mimeType: 'image/svg+xml',
                        filename: `${barcodeNumber}.svg`
                    });
                }

            } catch (error) {
                console.error('Adobe Express 오류:', error);
                alert('AI 파일 생성 중 오류가 발생했습니다.');
            }
        }

        // PDF 저장 함수
        async function exportToPDF() {
            const preview = document.getElementById('barcodePreview');
            const barcodeNumber = document.getElementById('barcodeNumber').value;
            
            if (!preview.innerHTML) {
                alert('먼저 바코드를 생성해주세요.');
                return;
            }

            try {
                const canvas = await html2canvas(preview, {
                    scale: 2,
                    logging: false,
                    useCORS: true
                });

                await generatePDF(canvas, barcodeNumber);
            } catch (error) {
                console.error(error);
                alert('PDF 저장 중 오류가 발생했습니다.');
            }
        }

        // PDF 생성 함수
        async function generatePDF(canvas, barcodeNumber) {
            const imageData = canvas.toDataURL('image/png');
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({
                orientation: 'portrait',
                unit: 'mm',
                format: 'a4'
            });

            const imgWidth = 210;
            const imgHeight = (canvas.height * imgWidth) / canvas.width;

            doc.addImage(imageData, 'PNG', 0, 0, imgWidth, imgHeight);
            doc.save(`${barcodeNumber}.pdf`);
        }

        // 바코드 입력 필드 이벤트 리스너
        document.getElementById('barcodeNumber').addEventListener('input', function(e) {
            this.value = this.value.replace(/[^\d]/g, '');
            if (this.value.length > 13) {
                this.value = this.value.slice(0, 13);
            }
        });

        // 페이지 로드 시 Adobe Express SDK 초기화
        window.addEventListener('load', async () => {
            try {
                adobeEditor = await CCEverywhere.initialize(adobeExpressConfig);
            } catch (error) {
                console.error('Adobe Express SDK 초기화 오류:', error);
            }
        });
    </script>
</body>
</html>